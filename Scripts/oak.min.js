function Oak_gen_MIPS(){var formats=[],instructions=[];formats.push(new Format("R",[new BitRange("opcode",26,6),new BitRange("rs",21,5,1),new BitRange("rt",16,5,2),new BitRange("rd",11,5,0),new BitRange("shamt",6,5,null,0),new BitRange("funct",0,6)],["rd","rt","rs"],[Parameter.register,Parameter.register,Parameter.register],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(\$[A-Za-z0-9]+)\s*,\s*(\$[A-Za-z0-9]+)/,"@mnem @arg, @arg, @arg"));var rType=formats[formats.length-1];instructions.push(new Instruction("ADD",rType,["opcode","funct"],[0,32],function(core){return core.rd=core.rfBubble.arguments[0],core.rfBubble.rsData+core.rfBubble.rtData},function(core){return null},function(core){return core.registerFile.write(core.tcBubble.arguments[0],core.tcBubble.aluOut),0})),instructions.push(new Instruction("XOR",rType,["opcode","funct"],[0,38],function(core){return core.rd=core.rfBubble.arguments[0],core.rfBubble.rsData^core.rfBubble.rtData},function(core){return null},function(core){return core.registerFile.write(core.tcBubble.arguments[0],core.tcBubble.aluOut),0})),instructions.push(new Instruction("SLT",rType,["opcode","funct"],[0,42],function(core){return core.rd=core.rfBubble.arguments[0],core.rfBubble.rsData<core.rfBubble.rtData?1:0},function(core){return null},function(core){return core.registerFile.write(core.tcBubble.arguments[0],core.tcBubble.aluOut),0})),formats.push(new Format("RJ",[new BitRange("opcode",26,6),new BitRange("rs",21,5,0),new BitRange("rt",16,5,null,0),new BitRange("rd",11,5,null,0),new BitRange("shamt",6,5,null,0),new BitRange("funct",0,6)],["rs"],[Parameter.register],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)/,"@mnem @arg"));var rjSubtype=formats[formats.length-1];instructions.push(new Instruction("JR",rjSubtype,["opcode","funct"],[0,8],function(core){return null},function(core){return core.rd=31,null},function(core){return null})),formats.push(new Format("RC",[new BitRange("funct",0,32)],[],[],/[a-zA-Z]+/,"@mnem"));var rcSubtype=formats[formats.length-1];instructions.push(new Instruction("SYSCALL",rcSubtype,["funct"],[12],function(core){return this.rd=null,null},function(core){return null},function(core){throw core.ecall(),"SYSCALL"})),instructions.push(new Instruction("NOP",rcSubtype,["funct"],[0],function(core){return this.rd=null,null},function(core){return null},function(core){return null})),formats.push(new Format("I",[new BitRange("opcode",26,6),new BitRange("rs",21,5,1),new BitRange("rt",16,5,0),new BitRange("imm",0,16,2)],["rt","rs","imm"],[Parameter.register,Parameter.register,Parameter.immediate],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(\$[A-Za-z0-9]+)\s*,\s*(-?[a-zA-Z0-9_]+)/,"@mnem @arg, @arg, @arg"));var iType=formats[formats.length-1];instructions.push(new Instruction("ADDI",iType,["opcode"],[8],function(core){return core.rd=core.rfBubble.arguments[0],core.rfBubble.rsData+core.rfBubble.arguments[2]},function(core){return null},function(core){return core.registerFile.write(core.tcBubble.arguments[0],core.tcBubble.aluOut),0})),formats.push(new Format("IB",[new BitRange("opcode",26,6),new BitRange("rs",21,5,0),new BitRange("rt",16,5,1),new BitRange("imm",0,16,2)],["rt","rs","imm"],[Parameter.register,Parameter.register,Parameter.special],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(\$[A-Za-z0-9]+)\s*,\s*(-?[a-zA-Z0-9_]+)/,"@mnem @arg, @arg, @arg",0,1,function(address,text,bits,labels,addresses){var array=text.split(""),result={errorMessage:null,value:null},int=NaN,labelLocation=labels.indexOf(text);if(labelLocation!==-1)int=addresses[labelLocation];else{var radix=10,splice=!1;"0"===array[0]&&("b"==array[1]&&(radix=2,splice=!0),"o"==array[1]&&(radix=8,splice=!0),"d"==array[1]&&(radix=10,splice=!0),"x"==array[1]&&(radix=16,splice=!0));var interpretable=text;splice&&(interpretable=array.splice(2,array.length-2).join("")),int=parseInt(interpretable,radix)}return isNaN(int)?(result.errorMessage="Offset '"+text+"' is not a recognized label or literal.",result):0!=(3&int)?(result.errorMessage="Branches must be word-aligned.",result):(int-=address,int>>=2,rangeCheck(int,16)?(result.value=int,result):(result.errorMessage="The value of '"+text+"' is out of range.",result))},function(value,address){return value<<2}));var ibSubtype=formats[formats.length-1];instructions.push(new Instruction("BEQ",ibSubtype,["opcode"],[4],function(core){return core.rfBubble.rsData==core.rfBubble.rtData?1:0},function(core){return null},function(core){return null})),instructions.push(new Instruction("BNE",ibSubtype,["opcode"],[5],function(core){return core.rfBubble.rsData!=core.rfBubble.rtData?1:0},function(core){return null},function(core){return null})),instructions.push(new Instruction("BLE",ibSubtype,["opcode"],[6],function(core){return core.rfBubble.rsData<=core.rfBubble.rtData?1:0},function(core){return null},function(core){return null})),formats.push(new Format("ILS",[new BitRange("opcode",26,6),new BitRange("rs",21,5,2),new BitRange("rt",16,5,0),new BitRange("imm",0,16,1)],["rt","imm","rs"],[Parameter.register,Parameter.immediate,Parameter.register],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(-?0?[boxd]?[0-9A-F]+)\s*\(\s*(\$[A-Za-z0-9]+)\s*\)/,"@mnem @arg, @arg(@arg)"));var ilsSubtype=formats[formats.length-1];instructions.push(new Instruction("LW",ilsSubtype,["opcode"],[35],function(core){return core.rd=null,core.rfBubble.rsData+core.rfBubble.arguments[1]},function(core){var bytes=core.memcpy(core.df1Bubble.aluOut,4);return null==bytes?-1:(core.df2Bubble.readData=catBytes(bytes),console.log("read data"+core.df2Bubble.readData),0)},function(core){return core.registerFile.write(arguments[0],core.tcBubble.readData),0})),instructions.push(new Instruction("SW",ilsSubtype,["opcode"],[43],function(core){return core.rd=arguments[0],core.rfBubble.rsData+core.rfBubble.arguments[1]},function(core){var bytes=[],value=core.eBubble.rtData;return console.log("rtData @ sw "+value),bytes.push(255&value),value>>>=8,bytes.push(255&value),value>>>=8,bytes.push(255&value),value>>>=8,bytes.push(255&value),console.log(core.df1Bubble.aluOut,bytes),core.memset(core.df1Bubble.aluOut,bytes)?0:-1},function(core){return null})),formats.push(new Format("J",[new BitRange("opcode",26,6),new BitRange("imm",0,26,0,null,32)],["imm"],[Parameter.special],/[A-z]+\s*([A-Za-z0-9_]+)/,"@mnem @arg",0,0,function(address,text,bits,labels,addresses){var array=text.split(""),result={errorMessage:null,value:null},int=NaN,labelLocation=labels.indexOf(text);if(labelLocation!==-1)int=addresses[labelLocation];else{var radix=10,splice=!1;"0"===array[0]&&("b"==array[1]&&(radix=2,splice=!0),"o"==array[1]&&(radix=8,splice=!0),"d"==array[1]&&(radix=10,splice=!0),"x"==array[1]&&(radix=16,splice=!0));var interpretable=text;splice&&(interpretable=array.splice(2,array.length-2).join("")),int=parseInt(interpretable,radix)}return isNaN(int)?(result.errorMessage="Offset '"+text+"' is not a recognized label or literal.",result):int>>>28==address>>>28?0==(3&int)?(result.value=(268435452&int)>>>2,result):(result.errorMessage="Jumps must be word-aligned.",result):(result.errorMessage="The value of '"+text+"' is out of range.",result)},function(value,address){return value<<2|4026531840&address}));var jType=formats[formats.length-1];return instructions.push(new Instruction("J",jType,["opcode"],[2],function(core){return null},function(core){return null},function(core){return null})),instructions.push(new Instruction("JAL",jType,["opcode"],[3],function(core){return null},function(core){return null},function(core){return core.registerFile.write(31,core.tcBubble.pc),0})),instructions.push(new Instruction("JUMP_PROCEDURE",jType,["opcode"],[99],function(core){return null},function(core){return null},function(core){return null})),instructions.push(new Instruction("RETURN_PROCEDURE",jType,["opcode"],[100],function(core){return null},function(core){return null},function(core){return null})),new InstructionSet("mips",32,formats,instructions,[".word",".half",".byte",".asciiz"],[4,2,1,0],["$zero","$at","$v0","$v1","$a0","$a1","$a2","$a3","$t0","$t1","$t2","$t3","$t4","$t5","$t6","$t7","$s0","$s1","$s2","$s3","$s4","$s5","$s6","$s7","$t8","$t9","$k0","$k1","$gp","$sp","$fp","$ra"],function(address,text,type,bits,labels,addresses){var array=text.split(""),result={errorMessage:null,value:null};switch(type){case Parameter.register:var registerNo,index=this.abiNames.indexOf(text);return index!==-1?(result.value=index,result):"$"!==array[0]?(result.errorMessage="Register "+text+" does not exist.",result):(registerNo=parseInt(array.splice(1,array.length-1).join("")),0<=registerNo&&registerNo<=31?(result.value=registerNo,result):(result.errorMessage="Register "+text+" does not exist.",result));case Parameter.immediate:var int=NaN,labelIndex=labels.indexOf(text);if(labelIndex!==-1)int=addresses[labelIndex];else if(3===array.length&&"'"==array[0]&&"'"==array[2])int=array[1].charCodeAt(0);else{var radix=10,splice=!1;"0"===array[0]&&("b"==array[1]&&(radix=2,splice=!0),"o"==array[1]&&(radix=8,splice=!0),"d"==array[1]&&(radix=10,splice=!0),"x"==array[1]&&(radix=16,splice=!0));var interpretable=text;splice&&(interpretable=array.splice(2,array.length-2).join("")),int=parseInt(interpretable,radix)}return isNaN(int)?(result.errorMessage="Immediate '"+text+"' is not a recognized label, literal or character.",result):rangeCheck(int,bits)?(result.value=int,result):(result.errorMessage="The value of '"+text+"' is out of range.",result);case Parameter.offset:var int=NaN,labelLocation=labels.indexOf(text);if(labelLocation!==-1)int=addresses[labelLocation]-address;else{var radix=10,splice=!1;"0"===array[0]&&("b"==array[1]&&(radix=2,splice=!0),"o"==array[1]&&(radix=8,splice=!0),"d"==array[1]&&(radix=10,splice=!0),"x"==array[1]&&(radix=16,splice=!0));var interpretable=text;splice&&(interpretable=array.splice(2,array.length-2).join("")),int=parseInt(interpretable,radix)}return isNaN(int)?(result.errorMessage="Offset '"+text+"' is not a recognized label or literal.",result):rangeCheck(int,bits)?(result.value=int,result):(result.errorMessage="The value of '"+text+"' is out of range.",result);default:return result}},function(file){for(var result={errorMessage:null,labels:[],addresses:[],lines:[],pc:[]},address=0,text=!0,lines=file.split("\n"),i=0;i<lines.length;i++){var labelExtractor=/\s*(([A-Za-z_][A-Za-z0-9_]*):)?(.*)?/.exec(lines[i]);if(null==labelExtractor&&console.log("Congratulations, you broke regular expressions."),void 0!==labelExtractor[2]&&(result.labels.push(labelExtractor[2]),result.addresses.push(address)),lines[i]=labelExtractor[3],void 0!=lines[i]){for(var chars=lines[i].split(""),inString=!1,commentOut=!1,j=0;j<chars.length;j++)if(commentOut)"\n"!==chars[j]?(chars.splice(j,1),j--):commentOut=!1;else if('"'==chars[j]||"'"==chars[j])inString=!inString;else if(inString){if("\\"==chars[j])j++;else if("\n"==chars[j])return result.errorMessage="Line "+i+": Unterminated string.",result}else"#"==chars[j]&&(commentOut=!0,chars.splice(j,1),j--);lines[i]=chars.join(""),lines[i]=lines[i].split("' '").join("32");var directives=lines[i].split(" ").filter(function(value){return value.length>0});if(0!==directives.length){var directiveChars=directives[0].split("");if(text)if(".data"===directives[0]){if(text=!1,void 0!==directives[1])return result.errorMessage="Line "+i+": "+directives[1]+" is extraneous. .data does not take any arguments.",result}else if(".text"===directives[0]);else{if("."===directiveChars[0])return result.errorMessage="Line "+i+": "+directives[0]+" cannot be in the text section. Aborting.",result;address+=4;var instructionIndex=this.mnemonicSearch(directives[0].toUpperCase());if(instructionIndex===-1)return result.errorMessage="Line "+i+": Instruction "+directives[0]+" not found.",result}else if(".text"==directives[0]){if(text=!0,void 0!==directives[1])return result.errorMessage="Line "+i+": "+directives[1]+" is extraneous. .text does not take any arguments.",result}else if(".data"===directives[0]);else{if(this.dataDirectives.indexOf(directives[0])===-1)return"."===directiveChars[0]?(result.errorMessage="Line "+i+": Unsupported directive "+directives[0]+".",result):(result.errorMessage="Line "+i+": Unrecognized keyword "+directives[0]+".",result);var index=this.dataDirectives.indexOf(directives[0]);if(0!==this.dataDirectiveSizes[index]){var array=directives.join(" ").split(directives[i]).join("").split(",");address+=array.length*this.dataDirectiveSizes[index]}else switch(directives[0]){case".asciiz":case".ascii":var match=/.([A-Za-z]+?)\s*\"(.*)\"\s*(#.*)?$/.exec(lines[i]);if(null==match)return result.errorMessage="Line "+i+": Malformed string directive.",result;for(var array=match[1].split(""),j=0;j<array.length;j++)"\\"==array[j]&&j++,address+=1;".asciiz"==directives[0]&&(address+=1)}}result.pc.push(address)}}}return result.lines=lines,result},function(nester,address,lines,labels,addresses){void 0===nester&&(nester=null);for(var result={errorMessage:null,machineCode:[],size:0},text=!0,i=0;i<lines.length;i++)if(void 0!==lines[i]){var directives=lines[i].split(" ").filter(function(value){return value.length>0});if(0!==directives.length)if(text)if(".data"===directives[0])text=!1;else if(".text"===directives[0]);else{address+=4;var instructionIndex=this.mnemonicSearch(directives[0].toUpperCase());if(instructionIndex===-1)return result.errorMessage="Line "+(null==nester?"":nester+":")+i+": Instruction "+directives[0]+" not found.",result;var instruction=this.instructions[instructionIndex],format=instruction.format,bitRanges=format.ranges,regex=format.regex,params=format.parameters,paramTypes=format.parameterTypes,machineCode=instruction.template(),match=regex.exec(lines[i]);if(null==match)return result.errorMessage="Line "+(null==nester?"":nester+":")+i+": Argument format for "+directives[0]+" violated.",result;for(var args=match.splice(1,params.length),j=0;j<bitRanges.length;j++)if(null!=bitRanges[j].parameter){var startBit=0,endBit=null,bits=bitRanges[j].bits,field=bitRanges[j].field,limits=/([A-za-z]+)\s*\[\s*(\d+)\s*:\s*(\d+)\s*\]/.exec(bitRanges[j].field);null!=limits&&(field=limits[1],bits=bitRanges[j].limitlessBits);var index=format.fieldParameterIndex(field),register=0;if(paramTypes[index]!==Parameter.special){var processed_1=this.processParameter(address,args[bitRanges[j].parameter],paramTypes[index],bits,labels,addresses);if(null!==processed_1.errorMessage)return result.errorMessage="Line "+(null==nester?"":nester+":")+i+": "+processed_1.errorMessage,result;register=processed_1.value}else{var processed_2=instruction.format.processSpecialParameter(address,args[index],bits,labels,addresses);if(null!==processed_2.errorMessage)return result.errorMessage="Line "+(null==nester?"":nester+":")+i+": "+processed_2.errorMessage,result;register=processed_2.value}null!=limits&&(startBit=parseInt(limits[3]),endBit=parseInt(limits[2]),register>>>=startBit,register&=(1<<endBit-startBit+1)-1),machineCode|=(register&(1<<bitRanges[j].bits)-1)<<bitRanges[j].start}for(var j=0;j<4;j++)result.machineCode.push(255&machineCode),machineCode>>>=8}else if(".text"==directives[0])text=!0;else if(this.dataDirectives.indexOf(directives[0])!==-1){var index=this.dataDirectives.indexOf(directives[0]);if(0!==this.dataDirectiveSizes[index])for(var size=this.dataDirectiveSizes[index],array=lines[i].split("' '").join("'$OAK_SPACE_TEMP'").split(directives[0]).join("").split(" ").join("").split("'$OAK_SPACE_TEMP'").join("' '").split(","),j=0;j<array.length;j++){var processed=this.processParameter(address,array[j],Parameter.immediate,8*size,labels,addresses);if(null!==processed.errorMessage)return result.errorMessage="Line "+(null==nester?"":nester+":")+i+": "+processed.errorMessage,result;for(var k=0;k<size;k++)address+=1,result.machineCode.push(255&processed.value),processed.value=processed.value>>>8}else switch(directives[0]){case".asciiz":case".ascii":var stringMatch=/.([A-Za-z]+?)\s*\"(.*)\"\s*(#.*)?$/.exec(lines[i]);if(null==stringMatch)return result.errorMessage="Line "+i+": Malformed string directive.",result;void 0==stringMatch[1]&&(stringMatch[1]="");for(var characters=stringMatch[1].split(""),j=0;j<characters.length;j++){if("\\"==characters[j]){if(++j+1<characters.length)switch(characters[j+1]){case"n":result.machineCode.push(10);break;case"0":result.machineCode.push(0);break;case"'":result.machineCode.push(39);break;case"\\":result.machineCode.push(92);break;default:result.machineCode.push(characters[j].charCodeAt(0))}}else result.machineCode.push(characters[j].charCodeAt(0));address+=1}".asciiz"==directives[0]&&(result.machineCode.push(0),address+=1)}}}return result.size=address,result})}function rangeCheck(value,bits){if(32==bits)return!0;if(bits>32)return!1;var min=-(1<<bits-1),max=(1<<bits-1)-1;return(value=signExt(value,bits))>>0<=max&&value>>0>=min}function signExt(value,bits){var mutableValue=value;return 0!=(mutableValue&1<<bits-1)&&(mutableValue=-1>>>bits<<bits|value),mutableValue}function catBytes(bytes){if(bytes.length>4)return null;for(var storage=0,i=0;i<bytes.length;i++)storage|=bytes[i]<<8*i;return storage}function h2b(hex){for(var hexArr=hex.split(" "),byteArr=[],i=0;i<hexArr.length;i++){var value=parseInt(hexArr[i],16);isNaN(value)||byteArr.push(value)}return byteArr}function assemble(core,data){var token=core.instructionSet.tokenize(data);return debug&&(console.log(token.labels),console.log(token.addresses)),null===token.errorMessage?core.instructionSet.assemble(null,0,token.lines,token.labels,token.addresses):{errorMessage:token.errorMessage,machineCode:null,size:0}}function loadIntoMemory(core,data){return null===core.memset(0,data)?"Program is too large.":null}function loadMemStep(core,data){var load=loadIntoMemory(core,data);if(null!==load)return load;simulateStep(core)}function passPipeline(core){var cycleParts=[],instName="";core.ifBubble.valid&&(instName=core.ifBubble.instruction.mnemonic,"NOP"!=instName?cycleParts.push("IF"):instName=""),core.isBubble.valid&&cycleParts.push("IS"),core.rfBubble.valid&&cycleParts.push("RF"),core.eBubble.stall?cycleParts.push("STALL"):core.eBubble.valid&&cycleParts.push("EX"),core.df1Bubble.valid&&cycleParts.push("DF"),core.df2Bubble.valid&&cycleParts.push("DS"),core.tcBubble.valid&&cycleParts.push("TC"),core.writeBackValid&&cycleParts.push("WB"),core.addCycle(instName,cycleParts)}function simulateStep(core){var cycle=core.cycle();return"SYSCALL"==cycle?"@Oak_Ecall":null!=cycle?cycle:(core.instructionCallback("End of Cycle "+core.cycleCounter),passPipeline(core),null)}function simulate(core,data){var load=loadIntoMemory(core,data);return null!==load?load:continueSim(core)}function continueSim(core){for(var step=simulateStep(core),i=0,i=0;i<16384&&null===step;i++)step=simulateStep(core);return 16384==i?"ERROR: Possible Infinite Loop":null!==step?step:null}function registerRead(core,index){return core.registerFile.read(index)}function registerWrite(core,index,value){core.registerFile.write(index,value)}function getMemory(core){return core.memory}function getRegisterABINames(core){return core.registerFile.abiNames}function resetCore(core){core.clearPipeline(),core.reset()}var Parameter;!function(Parameter){Parameter[Parameter.immediate=0]="immediate",Parameter[Parameter.register=1]="register",Parameter[Parameter.condition=2]="condition",Parameter[Parameter.offset=3]="offset",Parameter[Parameter.special=4]="special"}(Parameter||(Parameter={}));var BitRange=function(){function BitRange(field,start,bits,parameter,constant,limitlessBits){void 0===parameter&&(parameter=null),void 0===constant&&(constant=null),void 0===limitlessBits&&(limitlessBits=null),this.field=field,this.start=start,this.bits=bits,this.parameter=parameter,this.constant=constant,this.limitlessBits=limitlessBits}return BitRange}(),Format=function(){function Format(name,ranges,parameters,parameterTypes,regex,disassembly,rData1Arg,rData2Arg,processSpecialParameter,decodeSpecialParameter){void 0===rData1Arg&&(rData1Arg=1),void 0===rData2Arg&&(rData2Arg=2),void 0===processSpecialParameter&&(processSpecialParameter=null),void 0===decodeSpecialParameter&&(decodeSpecialParameter=null),this.name=name,this.parameters=parameters,this.ranges=ranges,this.parameterTypes=parameterTypes,this.regex=regex,this.disassembly=disassembly,this.processSpecialParameter=processSpecialParameter,this.decodeSpecialParameter=decodeSpecialParameter,this.rData1Arg=rData1Arg,this.rData2Arg=rData2Arg}return Format.prototype.disassemble=function(mnemonic,args,abiNames){var output=this.disassembly;output=output.replace("@mnem",mnemonic);for(var i=0;i<this.parameters.length;i++){if(null==args[i]||output.search("@arg")===-1){console.log("Disassembler note: Argument mismatch.");break}output=output.replace("@arg",this.parameterTypes[i]===Parameter.register?abiNames[args[i]]:args[i].toString())}return output},Format.prototype.parameterBitRangeIndex=function(parameter){for(var i=0;i<this.ranges.length;i++){if(this.ranges[i].field===parameter)return i;var limits=/([A-za-z]+)\s*\[\s*(\d+)\s*:\s*(\d+)\s*\]/.exec(this.ranges[i].field);if(null!==limits&&limits[1]===parameter)return i}return null},Format.prototype.fieldParameterIndex=function(range){for(var i=0;i<this.parameters.length;i++)if(this.parameters[i]==range)return i;return null},Format}(),Instruction=function(){function Instruction(mnemonic,format,constants,constValues,executor,memory,wb,signed,available){void 0===signed&&(signed=!0),void 0===available&&(available=!0),this.mnemonic=mnemonic,this.format=format,this.constants=constants,this.constValues=constValues,this.available=available,this.signed=signed,this.executor=executor,this.writeBack=wb,this.memory=memory}return Instruction.prototype.pad=function(str,length){for(var padded=str,i=0;i<length-str.length;i++)padded="0"+padded;return padded},Instruction.prototype.mask=function(){for(var str="",i=0;i<this.format.ranges.length;i++){var index=this.constants.indexOf(this.format.ranges[i].field);if(index!==-1)str+=this.pad(this.constValues[index].toString(2),this.format.ranges[i].bits);else if(null!=this.format.ranges[i].constant)str+=this.pad(this.format.ranges[i].constant.toString(2),this.format.ranges[i].bits);else for(var j=0;j<this.format.ranges[i].bits;j++)str+="X"}return str},Instruction.prototype.match=function(machineCode){for(var machineCodeMutable=machineCode>>>0,maskBits=this.mask().split(""),i=31;i>=0;i--)if("X"!==maskBits[i]){if(parseInt(maskBits[i])!==(1&machineCodeMutable))return!1;machineCodeMutable>>>=1}else machineCodeMutable>>>=1;return!0},Instruction.prototype.template=function(){return parseInt(this.mask().split("X").join("0"),2)},Instruction}(),InstructionSet=function(){function InstructionSet(name,bits,formats,instructions,dataDirectives,dataDirectiveSizes,abiNames,process,tokenize,assemble){this.name=name,this.bits=bits,this.formats=formats,this.instructions=instructions,this.dataDirectives=dataDirectives,this.dataDirectiveSizes=dataDirectiveSizes,this.abiNames=abiNames,this.processParameter=process,this.tokenize=tokenize,this.assemble=assemble}return InstructionSet.prototype.mnemonicSearch=function(mnemonic){for(var i=0;i<this.instructions.length;i++)if(this.instructions[i].mnemonic==mnemonic)return i;return-1},InstructionSet}(),MIPS=Oak_gen_MIPS(),MIPSRegisterFile=function(){function MIPSRegisterFile(memorySize,abiNames){this.physicalFile=[],this.modifiedRegisters=[];for(var i=0;i<32;i++)this.physicalFile.push(0),this.modifiedRegisters.push(!1);this.memorySize=memorySize,this.physicalFile[29]=memorySize,this.abiNames=abiNames}return MIPSRegisterFile.prototype.print=function(){console.log("Registers\n------");for(var i=0;i<32;i++)console.log("$"+i.toString(),this.abiNames[i],this.physicalFile[i].toString(),(this.physicalFile[i]>>>0).toString(16).toUpperCase());console.log("------")},MIPSRegisterFile.prototype.read=function(registerNumber){return 0===registerNumber?0:this.physicalFile[registerNumber]},MIPSRegisterFile.prototype.write=function(registerNumber,value){this.physicalFile[registerNumber]=value,this.modifiedRegisters[registerNumber]=!0},MIPSRegisterFile.prototype.getRegisterCount=function(){return 32},MIPSRegisterFile.prototype.getModifiedRegisters=function(){for(var modReg=this.modifiedRegisters.slice(),i=0;i<this.getRegisterCount();i++)this.modifiedRegisters[i]=!1;return modReg},MIPSRegisterFile.prototype.reset=function(){for(var i=0;i<32;i++)this.physicalFile[i]=0,this.modifiedRegisters[i]=!1;this.physicalFile[29]=this.memorySize},MIPSRegisterFile}(),BranchPredictor=function(){function BranchPredictor(){this.state=0}return BranchPredictor.prototype.sendResult=function(branched){branched?(this.state-=1,this.state<0&&(this.state=0)):(this.state+=1,this.state>3&&(this.state=3))},BranchPredictor.prototype.getPrediction=function(){return 1!=(this.state>>1&1)},BranchPredictor}(),MIPSCore=function(){function MIPSCore(memorySize,ecall,instructionCallback,addCycle,clearPipeline){this.stack=[0,0,0,0],this.ifBubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1},this.isBubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1},this.rfBubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1,rsData:null,rtData:null},this.eBubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1,rsData:null,rtData:null,aluOut:null,rd:null,stall:!1},this.df1Bubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1,rsData:null,rtData:null,aluOut:null,rd:null,readData:null},this.df2Bubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1,rsData:null,rtData:null,aluOut:null,rd:null,readData:null},this.tcBubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1,rsData:null,rtData:null,aluOut:null,rd:null,readData:null},this.instructionSet=MIPS,this.memorySize=memorySize,this.registerFile=new MIPSRegisterFile(memorySize,MIPS.abiNames),this.predictor=new BranchPredictor,this.ecall=ecall,this.instructionCallback=instructionCallback,this.addCycle=addCycle,this.clearPipeline=clearPipeline,this.reset()}return MIPSCore.prototype.memcpy=function(address,bytes){if(address+bytes>this.memorySize)return null;for(var result=[],i=0;i<bytes;i++)result.push(this.memory[address+i]);return result},MIPSCore.prototype.memset=function(address,bytes){if(address<0)return!1;if(address+bytes.length>this.memorySize)return!1;for(var i=0;i<bytes.length;i++)this.memory[address+i]=bytes[i];return!0},MIPSCore.prototype.fetchAndDecode=function(){var result={fetched:null,text:null,instruction:null,arguments:null,error:null};if(this.pc<0)return result.error="Fetch Error: Negative program counter.",result;var arr=this.memcpy(this.pc,4);if(null==arr)return result.error="Fetch Error: Illegal memory access.",result;this.pcNext=this.pc+4;for(var fetched=catBytes(arr),insts=this.instructionSet.instructions,decoded=null,args=[],i=0;i<insts.length;i++)if(insts[i].match(fetched)){decoded=insts[i];break}if(null==decoded)return result.error="Address 0x"+(this.pc-4).toString(16).toUpperCase()+": Instruction unrecognized or unsupported.",result;for(var format=decoded.format,bitRanges=format.ranges,params=format.parameters,paramTypes=format.parameterTypes,i=0;i<bitRanges.length;i++)if(null!=bitRanges[i].parameter){var limit=0,field=bitRanges[i].field,limits=/([A-za-z]+)\s*\[\s*(\d+)\s*:\s*(\d+)\s*\]/.exec(bitRanges[i].field);null!=limits&&(field=limits[1],limit=parseInt(limits[3])>>>0);var index=format.fieldParameterIndex(field),bits=bitRanges[i].bits,value=(fetched>>>bitRanges[i].start&(1<<bitRanges[i].bits)-1)<<limit;paramTypes[index]===Parameter.special&&(value=decoded.format.decodeSpecialParameter(value,this.pcNext)),args[bitRanges[i].parameter]=args[bitRanges[i].parameter]|value}for(var i=0;i<params.length;i++){var rangeIndex=format.parameterBitRangeIndex(params[i]);rangeIndex===-1&&console.log("Internal error: No field found for parameter "+params[i]+".");var bits=bitRanges[rangeIndex].bits;null!=bitRanges[rangeIndex].limitlessBits&&(bits=bitRanges[rangeIndex].limitlessBits),decoded.signed&&paramTypes[i]!=Parameter.register&&(args[i]=signExt(args[i],bits))}if("J"==decoded.format.name){if("JUMP_PROCEDURE"==decoded.mnemonic){if(this.stackPointer>=3)return"Jump procedure stack overflow.";this.stackPointer+=1,this.stack[this.stackPointer]=this.pcNext}if("RETURN_PROCEDURE"==decoded.mnemonic){if(this.stackPointer<0)return"Return procedure stack underflow.";this.stackPointer-=1}this.pcNext=args[0]}return result={fetched:fetched,text:format.disassemble(decoded.mnemonic,args,this.instructionSet.abiNames),instruction:decoded,arguments:args,error:null}},MIPSCore.prototype.cycle=function(){var fetched=this.fetchAndDecode();if(null!=fetched.error)return fetched.error;var stall_E=!1;if(this.rfBubble.valid){var rt_D=this.rfBubble.fetched>>16&31,rs_D=this.rfBubble.fetched>>21&31;if(this.eBubble.valid){var rt_E=this.eBubble.fetched>>16&31;this.eBubble.fetched;stall_E=stall_E||(rt_D==rt_E||rs_D==rt_E)&&"LW"==this.eBubble.instruction.mnemonic}if(this.df1Bubble.valid){var rt_E=this.df1Bubble.fetched>>16&31;this.df1Bubble.fetched;stall_E=stall_E||(rt_D==rt_E||rs_D==rt_E)&&"LW"==this.df1Bubble.instruction.mnemonic}if(this.df2Bubble.valid){var rt_E=this.df2Bubble.fetched>>16&31;this.df2Bubble.fetched;stall_E=stall_E||(rt_D==rt_E||rs_D==rt_E)&&"LW"==this.df2Bubble.instruction.mnemonic}}if(this.writeBackValid=this.tcBubble.valid,this.tcBubble.pc=this.df2Bubble.pc,this.tcBubble.fetched=this.df2Bubble.fetched,this.tcBubble.text=this.df2Bubble.text,this.tcBubble.instruction=this.df2Bubble.instruction,this.tcBubble.arguments=this.df2Bubble.arguments,this.tcBubble.valid=this.df2Bubble.valid,this.tcBubble.rsData=this.df2Bubble.rsData,this.tcBubble.rtData=this.df2Bubble.rtData,this.tcBubble.aluOut=this.df2Bubble.aluOut,this.tcBubble.rd=this.df2Bubble.rd,this.tcBubble.readData=this.df2Bubble.readData,this.tcBubble.valid)try{this.tcBubble.instruction.writeBack(this)}catch(e){return e}this.df2Bubble.pc=this.df1Bubble.pc,this.df2Bubble.fetched=this.df1Bubble.fetched,this.df2Bubble.text=this.df1Bubble.text,this.df2Bubble.instruction=this.df1Bubble.instruction,this.df2Bubble.arguments=this.df1Bubble.arguments,this.df2Bubble.valid=this.df1Bubble.valid,this.df2Bubble.rsData=this.df1Bubble.rsData,this.df2Bubble.rtData=this.df1Bubble.rtData,this.df2Bubble.aluOut=this.df1Bubble.aluOut,this.df2Bubble.rd=this.df1Bubble.rd,this.df2Bubble.readData=this.df1Bubble.readData;if(this.df2Bubble.valid&&this.df2Bubble.instruction.memory(this)==-1)return"Illegal access.";if(null!=this.eBubble.instruction&&"LW"==this.eBubble.instruction.mnemonic&&console.log("LW at "+(this.cycleCounter+1)),this.df1Bubble.pc=this.eBubble.pc,this.df1Bubble.fetched=this.eBubble.fetched,this.df1Bubble.text=this.eBubble.text,this.df1Bubble.instruction=this.eBubble.instruction,this.df1Bubble.arguments=this.eBubble.arguments,this.df1Bubble.valid=this.eBubble.valid,this.df1Bubble.rsData=this.eBubble.rsData,this.df1Bubble.rtData=this.eBubble.rtData,this.df1Bubble.aluOut=this.eBubble.aluOut,this.df1Bubble.rd=this.eBubble.rd,this.eBubble.pc=this.rfBubble.pc,this.eBubble.fetched=this.rfBubble.fetched,this.eBubble.text=this.rfBubble.text,this.eBubble.instruction=this.rfBubble.instruction,this.eBubble.arguments=this.rfBubble.arguments,this.eBubble.valid=this.rfBubble.valid,this.eBubble.rsData=this.rfBubble.rsData,this.eBubble.rtData=this.rfBubble.rtData,this.eBubble.stall=stall_E,this.eBubble.valid&&(this.eBubble.aluOut=this.rfBubble.instruction.executor(this),this.eBubble.rd=this.rd),stall_E&&(this.eBubble.valid=!1,console.log("Stalled Execution.")),!stall_E){this.pc=this.pcNext;var rfBubble=this.isBubble;if(rfBubble.valid){var rt=this.isBubble.fetched>>16&31,rs=this.isBubble.fetched>>21&31;rfBubble.rtData=this.registerFile.read(rt),console.log(rfBubble.rtData),rfBubble.rsData=this.registerFile.read(rs),
rt==this.eBubble.rd&&this.eBubble.valid?rfBubble.rtData=this.eBubble.aluOut:rt==this.df1Bubble.rd&&this.df1Bubble.valid?rfBubble.rtData=this.df1Bubble.aluOut:rt==this.df2Bubble.rd&&this.df2Bubble.valid&&(rfBubble.rtData=this.df2Bubble.aluOut),console.log(rfBubble.rtData),rs==this.eBubble.rd&&this.eBubble.valid?rfBubble.rsData=this.eBubble.aluOut:rs==this.df1Bubble.rd&&this.df1Bubble.valid?rfBubble.rsData=this.df1Bubble.aluOut:rs==this.df2Bubble.rd&&this.df2Bubble.valid&&(rfBubble.rsData=this.df2Bubble.aluOut)}this.rfBubble=rfBubble,this.isBubble=this.ifBubble,this.ifBubble={pc:this.pc,fetched:fetched.fetched,text:fetched.text,instruction:fetched.instruction,arguments:fetched.arguments,valid:!0}}return this.cycleCounter+=1,null},MIPSCore.prototype.reset=function(){this.pc=0,this.memory=[];for(var i=0;i<this.memorySize;i++)this.memory[i]=0;this.registerFile.reset(),this.writeBackValid=!1,this.ifBubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1},this.isBubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1},this.rfBubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1,rsData:null,rtData:null},this.eBubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1,rsData:null,rtData:null,aluOut:null,rd:null,stall:!1},this.df1Bubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1,rsData:null,rtData:null,aluOut:null,rd:null,readData:null},this.df2Bubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1,rsData:null,rtData:null,aluOut:null,rd:null,readData:null},this.tcBubble={pc:null,fetched:null,text:null,instruction:null,arguments:null,valid:!1,rsData:null,rtData:null,aluOut:null,rd:null,readData:null},this.cycleCounter=-1,this.stackPointer=-1},MIPSCore}(),debug=!1,consoleTests=!1;Array.prototype.Oak_hex=function(){for(var hexadecimal="",i=0;i<this.length;i++){var hexRepresentation=this[i].toString(16).toUpperCase();1===hexRepresentation.length&&(hexRepresentation="0"+hexRepresentation),hexadecimal+=hexRepresentation+" "}return hexadecimal};
